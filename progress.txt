# MyCoach — Progress Log

## Completed

### Phase 0: Foundation

- [x] **Project scaffolding** (commit 96d7a07)
  - pyproject.toml with dependencies (fastapi, sqlalchemy, alembic, pydantic, etc.)
  - Dev dependencies (pytest, pytest-asyncio, httpx, ruff, mypy)
  - Full directory structure per PRD Section 4
  - .env.example with placeholder env vars

- [x] **config.py with Pydantic Settings** (commit ce47409)
  - All settings groups: app, database, Garmin, Claude API, email, scheduler
  - MYCOACH_ env prefix, .env file support
  - Updated .env.example to match config field names

- [x] **database.py + main.py + test infrastructure** (commit fc7294f)
  - `database.py`: async SQLAlchemy engine, async_sessionmaker, DeclarativeBase, `get_db` FastAPI dependency
  - `main.py`: FastAPI app factory with lifespan (auto-creates tables), `GET /api/system/status` health check
  - `tests/conftest.py`: in-memory SQLite test engine, dependency override, auto-setup/teardown, async httpx client
  - `tests/test_api/test_system.py`: health check test (passing)

- [x] **Alembic async migrations setup**
  - Initialized Alembic with async template (`alembic init -t async`)
  - `alembic/env.py`: imports `Base.metadata` from `mycoach.database`, reads DB URL from `mycoach.config.Settings` dynamically
  - `render_as_batch=True` for SQLite ALTER TABLE compatibility
  - `alembic.ini`: removed hardcoded URL (driven by app config)
  - Verified: `alembic upgrade head` and `alembic revision --autogenerate` both work

- [x] **SQLAlchemy ORM models + Alembic migration**
  - 12 models across 8 files in `src/mycoach/models/`:
    - `user.py`: `User` — profile, fitness level, goals
    - `data_source.py`: `DataSourceConfig` — per-source config, credentials, sync status
    - `sport_profile.py`: `SportProfile` — per-sport skill level, goals, preferences, benchmarks
    - `availability.py`: `WeeklyAvailability` — time slots per day for upcoming week
    - `health.py`: `DailyHealthSnapshot` — HR, HRV, sleep, Body Battery, stress, training metrics, VO2max
    - `activity.py`: `Activity` + `GymWorkoutDetail` — workouts with HR/training effect; Hevy CSV sets/reps/weight/RPE
    - `plan.py`: `WeeklyPlan` + `PlannedSession` — generated plans with mesocycle tracking, linked to activities
    - `coaching.py`: `CoachingInsight` + `MesocycleConfig` — daily briefings, post-workout analysis, training blocks
    - `prompt_log.py`: `PromptLog` — LLM call tracking (tokens, latency, cost, prompt/response)
  - `models/__init__.py` re-exports all models
  - `main.py` and `alembic/env.py` import models to register with Base.metadata
  - Alembic autogenerate migration created and verified
  - All tests pass, ruff clean, mypy clean

- [x] **Pydantic schemas/DTOs in `schemas/`**
  - 9 schema files covering all 12 ORM models:
    - `user.py`: `UserCreate`, `UserUpdate`, `UserRead` with EmailStr validation
    - `data_source.py`: `DataSourceConfigCreate/Update/Read`, `DataSourceStatus`
    - `sport_profile.py`: `SportProfileCreate/Update/Read` with skill level validation
    - `availability.py`: `AvailabilitySlot`, `WeeklyAvailabilityCreate/Read`
    - `health.py`: `DailyHealthSnapshotCreate/Read` with all biometric fields
    - `activity.py`: `ActivityCreate/Read`, `GymWorkoutDetailCreate/Read` with RPE validation (1-10)
    - `plan.py`: `WeeklyPlanCreate/Read`, `PlannedSessionCreate/Read` with nested sessions
    - `coaching.py`: `CoachingInsightCreate/Read`, `MesocycleConfigCreate/Update/Read`
    - `system.py`: `StatusResponse`
  - `schemas/__init__.py` re-exports all 22 public schemas
  - Added `email-validator>=2.0.0` dependency for `EmailStr`
  - Validation: regex patterns for enums (fitness_level, skill_level, phase, insight_type, set_type), Field constraints (ge/le for day_of_week, rpe)
  - `from_attributes=True` on all Read schemas for ORM compatibility
  - 26 tests in `tests/test_schemas.py` covering valid/invalid cases
  - All tests pass, ruff clean, mypy clean

### Phase 1: Data Sources (in progress)

- [x] **Data source plugin system + Hevy CSV import**
  - `sources/base.py`: Abstract `DataSource` interface with `authenticate()`, `fetch_and_import()`, and `ImportResult` dataclass
  - `sources/hevy/csv_parser.py`: Parses Hevy CSV exports into `HevyWorkout`/`HevySet` dataclasses
    - Unit conversion: lbs→kg, miles→meters
    - Validates required columns, set_index, RPE range (1-10), datetime formats
    - BOM stripping for Windows-exported CSVs
    - Groups CSV rows into workouts by (title, start_time)
  - `sources/hevy/mappers.py`: Imports parsed workouts into DB as `Activity` + `GymWorkoutDetail` records
    - Deduplication by (user_id, title, start_time, data_source)
    - Duration calculation from start/end times
  - `api/routes/sources.py`: `POST /api/sources/import/hevy` endpoint (file upload)
  - Router registered in `main.py`
  - Added B008 ignore to ruff config (standard FastAPI `Depends()` pattern)
  - 20 new tests in `tests/test_sources/test_hevy.py`: CSV parsing (11), DB import (5), API endpoint (4)
  - All 47 tests pass, ruff clean, mypy clean

- [x] **Health + Activities API endpoints**
  - `api/routes/health.py`: 3 endpoints
    - `GET /api/health/today` — today's health snapshot (404 if none)
    - `GET /api/health/{date}` — snapshot for a specific date
    - `GET /api/health/trends?days=N` — last N days of snapshots (default 30, max 365)
  - `api/routes/activities.py`: 2 endpoints
    - `GET /api/activities` — paginated list with optional `sport` filter, includes gym workout details for gym activities
    - `GET /api/activities/{id}` — single activity with gym details
  - `PaginatedActivities` response model with `items`, `total`, `page`, `per_page`
  - Gym workout details loaded via join query (ordered by set_index)
  - Both routers registered in `main.py`
  - 15 new tests: health endpoints (7), activities endpoints (8)
  - All 62 tests pass, ruff clean, mypy clean

- [x] **Garmin source (auth, client, fetcher, mappers)**
  - `sources/garmin/auth.py`: `GarminAuth` class for authentication via garth
    - Token persistence: saves/resumes tokens from disk (configurable `garmin_token_dir`)
    - Fallback: resumes from saved tokens first, falls back to email/password login
    - Robust re-auth on token expiration
  - `sources/garmin/client.py`: `GarminClient` wrapper around garminconnect library
    - Methods for all health endpoints: stats, HR, HRV, sleep, stress, Body Battery, training readiness/status, VO2 max, respiration, SpO2
    - `get_activities_by_date()` for activity fetching
  - `sources/garmin/mappers.py`: Maps raw Garmin JSON to ORM models
    - `map_health_snapshot()`: Builds `DailyHealthSnapshot` from 10+ API responses, handles missing data gracefully, stores raw JSON for debugging
    - `map_activity()`: Maps Garmin activities to `Activity` model with sport classification (swimming, gym, cardio, other)
    - `import_health_snapshot()`: DB import with date-based deduplication
    - `import_activities()`: DB import with Garmin activity ID deduplication
    - Sport classification map: `GARMIN_SPORT_MAP` covering swimming variants, strength, cardio types
  - `sources/garmin/source.py`: `GarminSource` implements `DataSource` interface
    - `fetch_and_import()`: Orchestrates day-by-day health fetch + activity range fetch
    - `_safe_call()`: Wraps each API call so partial data is still captured on individual failures
    - Default 7-day lookback, configurable via `since` parameter
  - `api/routes/sources.py`: `POST /api/sources/sync/garmin` endpoint
    - Query param `days` (1-90, default 7) controls lookback period
    - Returns `GarminSyncResponse` with activities_created/skipped, health_snapshots_created, errors
    - 503 on auth failure with descriptive message
  - Enabled `garminconnect>=0.2.0` and `garth>=0.4.0` dependencies in pyproject.toml
  - 17 new tests in `tests/test_sources/test_garmin.py`:
    - Health snapshot mapper (3): full data, stats only, empty stats
    - Activity mapper (4): swimming, gym, unknown type, missing fields
    - DB import health (2): new + duplicate skip
    - DB import activities (3): new, duplicate skip, missing ID
    - GarminSource integration (2): fetch_and_import with mock client, auth failure
    - API endpoint (3): sync success, auth failure (503), days param
  - All 79 tests pass, ruff clean, mypy clean

## Next Up

- [ ] Phase 1 (cont.): Data merging logic (Garmin + Hevy by date/time overlap)
- [ ] Phase 1 (cont.): `GET /api/sources/status` endpoint
